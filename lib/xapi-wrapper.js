// Generated by CoffeeScript 1.7.1
(function() {
  var Connector, Emitter, Wrapper, print;

  Connector = require('xapi-connector');

  Emitter = require('events').EventEmitter;

  print = function(msg) {
    return console.log(msg);
  };

  Wrapper = (function() {
    function Wrapper(server_url, conn_port, stream_port, username, password) {
      this.server_url = server_url;
      this.conn_port = conn_port;
      this.stream_port = stream_port;
      this.username = username;
      this.password = password;
      this.conn_status = 0;
      this.stream_status = 0;
      this.stream_status = 0;
      this._req_id = 0;
      this._stream_session_id = null;
      this._requests = {};
      this._emitter = new Emitter();
      this._streamEmitter = new Emitter();
      this._connector = new Connector(this.server_url, this.conn_port, this.stream_port, this.username, this.password);
      this._connector.on('open', (function(_this) {
        return function() {
          _this.conn_status = 1;
          return _this._emitter.emit('open');
        };
      })(this));
      this._connector.on('close', (function(_this) {
        return function() {
          _this.conn_status = 2;
          return _this._emitter.emit('close');
        };
      })(this));
      this._connector.on('error', (function(_this) {
        return function() {
          _this.conn_status = 3;
          return _this._emitter.emit('error');
        };
      })(this));
      this._connector.on('message', (function(_this) {
        return function(msg) {
          var e, req, req_id, res;
          try {
            res = JSON.parse(msg);
            req_id = parseInt(res.customTag);
            req = _this._requests[req_id];
            if (req.customTag != null) {
              res.customTag = req.customTag;
            } else {
              delete res.customTag;
            }
            if (res.status === true) {
              _this._emitter.emit(req.command, req, res);
              return _this._emitter.emit('_message', JSON.stringify(res));
            } else {
              return _this._emitter.emit('apiError', req, res);
            }
          } catch (_error) {
            e = _error;
            return console.log(e);
          }
        };
      })(this));
      this._connector.onStream('message', (function(_this) {
        return function(msg) {
          var e;
          try {
            msg = JSON.parse(msg);
            return _this._streamEmitter(msg.command, msg);
          } catch (_error) {
            e = _error;
            return console.log(e);
          }
        };
      })(this));
      this._connector.onStream('open', function() {
        this.stream_status = 1;
        return this._streamEmitter.emit('open');
      });
      this._connector.onStream('close', function() {
        this.stream_status = 2;
        return this._streamEmitter.emit('close');
      });
      this._connector.onStream('error', function() {
        this.stream_status = 3;
        return this._streamEmitter.emit('error');
      });
      this.on('login', function(req, res) {
        return this._stream_session_id = res.streamSessionId;
      });
      this.on('apiError', function(req, res) {
        if (req.command === 'login' && (res.redirect != null)) {
          print("Server response to login: " + res);
          this.disconnect();
          this.server_url = res.redirect.address;
          this.conn_port = res.redirect.mainPort;
          this.stream_port = res.redirect.streamingPort;
          print("Redirecting to server: " + this.server_url + ", port: " + this.conn_port + ", stream port: " + stream_port);
          return this.connect();
        }
      });
    }

    Wrapper.prototype.on = function(event, callback) {
      return this._emitter.on(event, callback);
    };

    Wrapper.prototype.onStream = function(event, callback) {
      return this._streamEmitter.on(event, callback);
    };

    Wrapper.prototype._send = function(command, args, custom_tag) {
      var req, req_id;
      req_id = this._req_id += 1;
      this._requests[req_id] = {
        command: command,
        "arguments": args != null ? args : void 0,
        customTag: custom_tag != null ? custom_tag : void 0
      };
      req = this._connector.buildCommand(command, args, req_id.toString());
      return this._connector.send(req);
    };

    Wrapper.prototype.connect = function() {
      return this._connector.connect();
    };

    Wrapper.prototype.disconnect = function() {
      return this._connector.disconnect();
    };

    Wrapper.prototype.login = function(custom_tag) {
      return this._send('login', {
        userId: this.username,
        password: this.password
      }, custom_tag);
    };

    Wrapper.prototype.logout = function(custom_tag) {
      return this._send('logout', null, custom_tag);
    };

    Wrapper.prototype.ping = function(custom_tag) {
      return this._send('ping', null, custom_tag);
    };

    Wrapper.prototype.addOrder = function(args, custom_tag) {
      return this._send('addOrder', args, custom_tag);
    };

    Wrapper.prototype.closePosition = function(args, custom_tag) {
      return this._send('closePosition', args, custom_tag);
    };

    Wrapper.prototype.closePositions = function(args, custom_tag) {
      return this._send('closePositions', args, custom_tag);
    };

    Wrapper.prototype.deletePending = function(args, custom_tag) {
      return this._send('deletePending', args, custom_tag);
    };

    Wrapper.prototype.getAccountIndicators = function(custom_tag) {
      return this._send('getAccountIndicators', custom_tag);
    };

    Wrapper.prototype.getAccountInfo = function(args, custom_tag) {
      return this._send('getAccountInfo', args, custom_tag);
    };

    Wrapper.prototype.getAllSymbols = function(args, custom_tag) {
      return this._send('getAllSymbols', args, custom_tag);
    };

    Wrapper.prototype.getCalendar = function(args, custom_tag) {
      return this._send('getCalendar', args, custom_tag);
    };

    Wrapper.prototype.getCandles = function(args, custom_tag) {
      return this._send('getCandles', args, custom_tag);
    };

    Wrapper.prototype.getCashOperationsHistory = function(args) {
      return this._send('getCashOperationsHistory', args, custom_tag);
    };

    Wrapper.prototype.getCommisionsDef = function(args) {
      return this._send('getCommisionsDef', args, custom_tag);
    };

    Wrapper.prototype.getlbsHistory = function(args) {
      return this._send('getlbsHistory', args, custom_tag);
    };

    Wrapper.prototype.getMarginTrade = function(args) {
      return this._send('getMarginTrade', args, custom_tag);
    };

    Wrapper.prototype.getNews = function(args) {
      return this._send('getNews', args, custom_tag);
    };

    Wrapper.prototype.getOrderStatus = function(args) {
      return this._send('getOrderStatus', args, custom_tag);
    };

    Wrapper.prototype.getProfitCalculations = function(args) {
      return this._send('getProfitCalculations', args, custom_tag);
    };

    Wrapper.prototype.getServerTime = function(args) {
      return this._send('getServerTime', args, custom_tag);
    };

    Wrapper.prototype.getStepRules = function(args) {
      return this._send('getStepRules', args, custom_tag);
    };

    Wrapper.prototype.getSymbol = function(args) {
      return this._send('getSymbol', args, custom_tag);
    };

    Wrapper.prototype.getTickPrices = function(args) {
      return this._send('getTickPrices', args, custom_tag);
    };

    Wrapper.prototype.getTradeRecords = function(args) {
      return this._send('getTradeRecords', args, custom_tag);
    };

    Wrapper.prototype.getTrades = function(args) {
      return this._send('getTrades', args, custom_tag);
    };

    Wrapper.prototype.getTradesHistory = function(args) {
      return this._send('getTradesHistory', args, custom_tag);
    };

    Wrapper.prototype.getTradingHours = function(args) {
      return this._send('getTradingHours', args, custom_tag);
    };

    Wrapper.prototype.getVersion = function(args) {
      return this._send('getVersion', args, custom_tag);
    };

    Wrapper.prototype.modifyPending = function(args) {
      return this._send('modifyPending', args, custom_tag);
    };

    Wrapper.prototype.modifyPosition = function(args) {
      return this._send('modifyPosition', args, custom_tag);
    };

    Wrapper.prototype.subscribeAccountIndicators = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getAccountIndicators', this._stream_session_id));
    };

    Wrapper.prototype.subscribeCandles = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getCandles', this._stream_session_id));
    };

    Wrapper.prototype.subscribeKeepAlive = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getKeepAlive', this._stream_session_id));
    };

    Wrapper.prototype.subscribeNews = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getNews', this._stream_session_id));
    };

    Wrapper.prototype.subscribeOrderStatus = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getOrderStatus', this._stream_session_id));
    };

    Wrapper.prototype.subscribeProfits = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getProfits', this._stream_session_id));
    };

    Wrapper.prototype.subscribeTickPrices = function(stream_session_id, symbols) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getTickPrices', this._stream_session_id, symbols));
    };

    Wrapper.prototype.subscribeTrades = function(stream_session_id) {
      return this._connector.sendStream(this._connector.buildStreamCommand('getTrades', this._stream_session_id));
    };

    return Wrapper;

  })();

  module.exports = Wrapper;

}).call(this);
